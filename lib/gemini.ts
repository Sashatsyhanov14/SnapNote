/**
 * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å OpenRouter.
 * –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É 401, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization 
 * –∏ –Ω–∞–ª–∏—á–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ HTTP-Referer, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç—Å—è OpenRouter.
 */

const MODEL_GEMMA = "google/gemma-3-27b-it:free";
const MODEL_GEMINI_FLASH_LITE = "google/gemini-2.5-flash-lite";

const SYSTEM_INSTRUCTION = `–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ç–æ—Ä –∑–∞–º–µ—Ç–æ–∫.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Markdown –¥–æ–∫—É–º–µ–Ω—Ç.

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
–ö–ê–ñ–î–ê–Ø –∑–∞–º–µ—Ç–∫–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞ H1 (#).

üìè –ü–†–ê–í–ò–õ–û –î–õ–ò–ù–´:

**–î–ª—è –ö–û–†–û–¢–ö–ò–• —Ç–µ–∫—Å—Ç–æ–≤ (1-5 —Å–ª–æ–≤)**:
- –¢–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ H1 (#) + –ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
- –ë–ï–ó –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ H2 (##)
- –ú–∏–Ω–∏–º–∞–ª–∏–∑–º –∏ –ª–∞–∫–æ–Ω–∏—á–Ω–æ—Å—Ç—å

**–î–ª—è –î–õ–ò–ù–ù–´–• —Ç–µ–∫—Å—Ç–æ–≤ (6+ —Å–ª–æ–≤)**:
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ H1 (#)
- –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ H2 (##) –¥–ª—è –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤
- –°–ø–∏—Å–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê:

1. **–ó–ê–ì–û–õ–û–í–û–ö H1 (#)**: –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –í–°–ï–ì–î–ê –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º.
   - "# –ü–æ–∫—É–ø–∫–∏", "# –í—Å—Ç—Ä–µ—á–∞", "# –ò–¥–µ–∏", "# –ó–∞–¥–∞—á–∏"

2. **–°–ü–ò–°–ö–ò**: 
   - –ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ (-) –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
   - –ß–µ–∫–±–æ–∫—Å—ã ([ ]) –¥–ª—è –∑–∞–¥–∞—á –∏ –¥–µ–ª

3. **–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï**:
   - **–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** –¥–ª—è –¥–∞—Ç, –∏–º–µ–Ω (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ)
   - –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å

–ü–†–ò–ú–ï–†–´:

üìù –ö–û–†–û–¢–ö–ò–ô –í–í–û–î (1-5 —Å–ª–æ–≤):

–í—Ö–æ–¥: "–º–æ–ª–æ–∫–æ —Ö–ª–µ–± —è–π—Ü–∞"
–í—ã—Ö–æ–¥:
# –ü–æ–∫—É–ø–∫–∏

- –ú–æ–ª–æ–∫–æ
- –•–ª–µ–±
- –Ø–π—Ü–∞

---

–í—Ö–æ–¥: "–ø–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ"
–í—ã—Ö–æ–¥:
# –ó–∞–¥–∞—á–∏

- [ ] –ü–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ

---

üìù –î–õ–ò–ù–ù–´–ô –í–í–û–î (6+ —Å–ª–æ–≤):

–í—Ö–æ–¥: "–ø–æ–∑–≤–æ–Ω–∏—Ç—å –ò–≤–∞–Ω—É –æ–±—Å—É–¥–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –≤—Å—Ç—Ä–µ—á–∞ –≤ 15:00 –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é"
–í—ã—Ö–æ–¥:
# –í—Å—Ç—Ä–µ—á–∞ —Å –ò–≤–∞–Ω–æ–º

## –î–µ—Ç–∞–ª–∏
- **–í—Ä–µ–º—è**: 15:00
- **–¢–µ–º–∞**: –û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

## –ó–∞–¥–∞—á–∏
- [ ] –ü–æ–∑–≤–æ–Ω–∏—Ç—å –ò–≤–∞–Ω—É
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é

–ê–ë–°–û–õ–Æ–¢–ù–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û Markdown. –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤ - –ë–ï–ó –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤!
–ü–∏—à–∏ –Ω–∞ —è–∑—ã–∫–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞.`;

const POLISH_INSTRUCTION = `–¢—ã ‚Äî —ç–ª–∏—Ç–Ω—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–Ω–µ—Å –ø—Ä–∞–≤–∫–∏ –≤ –∑–∞–º–µ—Ç–∫—É.
–¢–≤–æ—è —Ü–µ–ª—å: –î–æ–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –¥–æ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–∞, —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É Markdown.

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ó–∞–º–µ—Ç–∫–∞ –û–ë–Ø–ó–ê–ù–ê –∏–º–µ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ H1 (#) –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ!

üìè –ü–†–ê–í–ò–õ–û: –°–û–•–†–ê–ù–Ø–ô —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å—Ö–æ–¥–Ω–æ–π –∑–∞–º–µ—Ç–∫–∏!
- –ï—Å–ª–∏ –∑–∞–º–µ—Ç–∫–∞ –ø—Ä–æ—Å—Ç–∞—è (—Ç–æ–ª—å–∫–æ H1 + —Å–ø–∏—Å–æ–∫) - –ù–ï —É—Å–ª–æ–∂–Ω—è–π –µ—ë –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
- –ï—Å–ª–∏ –∑–∞–º–µ—Ç–∫–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è (–µ—Å—Ç—å H2) - —Å–æ—Ö—Ä–∞–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É

–ß–¢–û –î–ï–õ–ê–¢–¨:

1. **–ü–†–û–í–ï–†–ö–ê –°–¢–†–£–ö–¢–£–†–´**:
   - –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ H1 (#)
   - –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π
   - –ù–ï –¥–æ–±–∞–≤–ª—è–π H2 (##) –µ—Å–ª–∏ –∏—Ö –Ω–µ –±—ã–ª–æ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ

2. **–£–õ–£–ß–®–ï–ù–ò–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø**:
   - –î–æ–±–∞–≤—å **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** –¥–ª—è –¥–∞—Ç, –∏–º–µ–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –ü—Ä–µ–æ–±—Ä–∞–∑—É–π –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–∏ (-, [ ])
   - –í—ã—Ä–æ–≤–Ω—è–π –æ—Ç—Å—Ç—É–ø—ã

3. **–ì–†–ê–ú–ú–ê–¢–ò–ö–ê –ò –°–¢–ò–õ–¨**:
   - –ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏
   - –£–±–µ—Ä–∏ –≤–æ–¥—É
   - –°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–º

–ü–†–ò–ú–ï–†–´:

üìù –ü–†–û–°–¢–ê–Ø –ó–ê–ú–ï–¢–ö–ê (–æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–æ—Å—Ç–æ–π):

–í—Ö–æ–¥:
# –ü–æ–∫—É–ø–∫–∏
–º–æ–ª–æ–∫–æ
—Ö–ª–µ–±

–í—ã—Ö–æ–¥:
# –ü–æ–∫—É–ø–∫–∏

- –ú–æ–ª–æ–∫–æ
- –•–ª–µ–±

---

üìù –ü–û–î–†–û–ë–ù–ê–Ø –ó–ê–ú–ï–¢–ö–ê (–æ—Å—Ç–∞—ë—Ç—Å—è –ø–æ–¥—Ä–æ–±–Ω–æ–π):

–í—Ö–æ–¥:
# –í—Å—Ç—Ä–µ—á–∞
–î–µ—Ç–∞–ª–∏
–≤—Ä–µ–º—è 15:00

–í—ã—Ö–æ–¥:
# –í—Å—Ç—Ä–µ—á–∞

## –î–µ—Ç–∞–ª–∏
- **–í—Ä–µ–º—è**: 15:00

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
- –ù–ï –º–µ–Ω—è–π —Å–º—ã—Å–ª
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç —Å–µ–±—è
- –ù–ï —É—Å–ª–æ–∂–Ω—è–π –ø—Ä–æ—Å—Ç—ã–µ –∑–∞–º–µ—Ç–∫–∏

–†–ï–ó–£–õ–¨–¢–ê–¢: –¢–æ–ª—å–∫–æ Markdown. –°–æ—Ö—Ä–∞–Ω—è–π –ø—Ä–æ—Å—Ç–æ—Ç—É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞!`;

const VOICE_CLEANUP_INSTRUCTION = `–¢—ã ‚Äî –º–æ–¥—É–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ (STT) –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.

‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –í–°–ï–ì–î–ê –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º H1 (#)!

üìè –ü–†–ê–í–ò–õ–û –°–¢–†–£–ö–¢–£–†–´:

**–î–ª—è –ö–û–†–û–¢–ö–ò–• —Ñ—Ä–∞–∑ (1-5 —Å–ª–æ–≤)**:
- –¢–æ–ª—å–∫–æ H1 (#) + –ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
- –ë–ï–ó –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ H2 (##)

**–î–ª—è –î–õ–ò–ù–ù–´–• —Ñ—Ä–∞–∑ (6+ —Å–ª–æ–≤)**:
- H1 (#) + –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ H2 (##) –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ
- –ü–æ–ª–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–≠–¢–ê–ü–´ –û–ë–†–ê–ë–û–¢–ö–ò:

1. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–û–ö STT**:
   - –ò—Å–ø—Ä–∞–≤—å –æ–∫–æ–Ω—á–∞–Ω–∏—è, –ø–∞–¥–µ–∂–∏ –∏ –æ–ø–µ—á–∞—Ç–∫–∏
   - –†–∞—Å—Å—Ç–∞–≤—å –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
   - –£–±–µ—Ä–∏ –ø–æ–≤—Ç–æ—Ä—ã

2. **–ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø –ö–û–ú–ê–ù–î** (–ù–ï –ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º):
   - "–ó–∞–≥–æ–ª–æ–≤–æ–∫..." ‚Üí # –ó–∞–≥–æ–ª–æ–≤–æ–∫
   - "–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫..." ‚Üí ## –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö)
   - "–ü—É–Ω–∫—Ç..." / "–¢–∏—Ä–µ..." ‚Üí - ...
   - "–ß–µ–∫–±–æ–∫—Å..." / "–ó–∞–¥–∞—á–∞..." ‚Üí [ ] ...

3. **–î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ì–û–õ–û–í–ö–ê** (–µ—Å–ª–∏ –Ω–µ –ø—Ä–æ–∏–∑–Ω–µ—Å–µ–Ω):
   - –ü—Ä–∏–¥—É–º–∞–π –∫—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ H1
   - –ü–æ—Å—Ç–∞–≤—å –µ–≥–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–æ–π

–ü–†–ò–ú–ï–†–´:

üìù –ö–û–†–û–¢–ö–ê–Ø –§–†–ê–ó–ê:

–í—Ö–æ–¥: "–º–æ–ª–æ–∫–æ —è–π—Ü–∞ —Ö–ª–µ–±"
–í—ã—Ö–æ–¥:
# –ü–æ–∫—É–ø–∫–∏

- –ú–æ–ª–æ–∫–æ
- –Ø–π—Ü–∞
- –•–ª–µ–±

---

–í—Ö–æ–¥: "–ø–æ–∑–≤–æ–Ω–∏—Ç—å –°–∞—à–µ"
–í—ã—Ö–æ–¥:
# –ó–∞–¥–∞—á–∏

- [ ] –ü–æ–∑–≤–æ–Ω–∏—Ç—å –°–∞—à–µ

---

üìù –î–õ–ò–ù–ù–ê–Ø –§–†–ê–ó–ê:

–í—Ö–æ–¥: "–≤—Å—Ç—Ä–µ—á–∞ —Å –°–∞—à–µ–π –∑–∞–≤—Ç—Ä–∞ –≤ —Ç—Ä–∏ —á–∞—Å–∞ –æ–±—Å—É–¥–∏—Ç—å –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ –±—é–¥–∂–µ—Ç –Ω–∞ —Ä–µ–∫–ª–∞–º—É"
–í—ã—Ö–æ–¥:
# –í—Å—Ç—Ä–µ—á–∞ —Å –°–∞—à–µ–π

## –î–µ—Ç–∞–ª–∏
- **–í—Ä–µ–º—è**: –ó–∞–≤—Ç—Ä–∞ –≤ 3 —á–∞—Å–∞

## –¢–µ–º—ã
- –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥
- –ë—é–¥–∂–µ—Ç –Ω–∞ —Ä–µ–∫–ª–∞–º—É

–†–ï–ó–£–õ–¨–¢–ê–¢: –¢–æ–ª—å–∫–æ Markdown. –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö - –ë–ï–ó –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤!`;

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ OpenRouter —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π fetch.
 * –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —Ç–∞–∫ –∫–∞–∫ –∫–ª—é—á–∏ OpenRouter –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å Google GenAI SDK.
 */
/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –Ω–∞—à–µ–º—É API (Serverless Function).
 * –≠—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç –∫–ª—é—á–∏ API –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å CORS.
 */
async function callBackendAPI(prompt: string, instruction: string, model: string): Promise<string | null> {
  try {
    console.log("üîÑ SnapNote: Trying Backend API...");
    console.log(`   Model: ${model}`);
    console.log(`   Prompt length: ${prompt.length} chars`);
    console.log(`   Instruction length: ${instruction.length} chars`);

    const response = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, instruction, model })
    });

    // If we get an HTML response (likely Vite serving index.html for unknown route), throw to trigger fallback
    const contentType = response.headers.get("content-type");
    if (contentType && contentType.includes("text/html")) {
      throw new Error("Local environment detected (HTML response from API)");
    }

    if (!response.ok) {
      // Any error status should trigger fallback
      const error = await response.text();
      console.error(`‚ùå SnapNote: Backend Error (${response.status}):`, error);
      throw new Error(`Backend API failed with status ${response.status}: ${error}`);
    }

    const data = await response.json();
    const result = data.choices?.[0]?.message?.content || null;
    console.log("‚úÖ SnapNote: Backend AI Success", result ? `(${result.length} chars)` : "(null)");
    return result;
  } catch (error) {
    console.warn("‚ö†Ô∏è SnapNote: Backend unreachable, trying client-side fallback...", error);
    throw error; // Rethrow to trigger fallback
  }
}

async function callOpenRouter(prompt: string, instruction: string, model: string, apiKey: string): Promise<string | null> {
  try {
    console.log("üîÑ SnapNote: Using Client-side OpenRouter...");
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`,
        "HTTP-Referer": "https://snapnote.tma",
        "X-Title": "SnapNote TMA"
      },
      body: JSON.stringify({
        model,
        messages: [
          { role: "system", content: instruction },
          { role: "user", content: `IMPORTANT INSTRUCTION:\n${instruction}\n\nUSER CONTENT:\n${prompt}` }
        ],
        temperature: 0.3,
        max_tokens: 1000
      })
    });

    if (!response.ok) {
      console.error("‚ùå SnapNote: OpenRouter Error", response.status);
      return null;
    }
    const data = await response.json();
    const result = data.choices?.[0]?.message?.content || null;
    console.log("‚úÖ SnapNote: Client-side AI Success", result ? `(${result.length} chars)` : "(null)");
    return result;
  } catch (e) {
    console.error("‚ùå SnapNote: Client-side API error", e);
    return null;
  }
}

async function callAI(prompt: string, instruction: string, model: string, clientKey?: string): Promise<string | null> {
  console.log(`ü§ñ SnapNote: Processing with AI (${model})...`);
  try {
    return await callBackendAPI(prompt, instruction, model);
  } catch (e) {
    if (clientKey) {
      console.log("SnapNote: Falling back to Client-side API call");
      return callOpenRouter(prompt, instruction, model, clientKey);
    }
    console.error("SnapNote: API Failed and no client key provided for fallback.");
    return null;
  }
}

export async function processNoteWithAI(text: string): Promise<string | null> {
  // Use VITE_API_KEY as fallback
  return callAI(text, SYSTEM_INSTRUCTION, MODEL_GEMMA, import.meta.env.VITE_API_KEY);
}

export async function improveEditedNote(text: string): Promise<string | null> {
  return callAI(text, POLISH_INSTRUCTION, MODEL_GEMMA, import.meta.env.VITE_API_KEY);
}

export async function processVoiceTranscript(text: string): Promise<string | null> {
  const key = import.meta.env.VITE_VOICE_AI_KEY || import.meta.env.VITE_API_KEY;
  return callAI(text, VOICE_CLEANUP_INSTRUCTION, MODEL_GEMINI_FLASH_LITE, key);
}
