/**
 * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å OpenRouter.
 * –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É 401, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization 
 * –∏ –Ω–∞–ª–∏—á–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ HTTP-Referer, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç—Å—è OpenRouter.
 */

const MODEL_GEMMA = "google/gemma-3-27b-it:free";
const MODEL_GEMINI_FLASH_LITE = "google/gemini-2.5-flash-lite";

const SYSTEM_INSTRUCTION = `–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ç–æ—Ä –∑–∞–º–µ—Ç–æ–∫.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ò–î–ï–ê–õ–¨–ù–û —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Markdown –¥–æ–∫—É–º–µ–Ω—Ç.

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
–ö–ê–ñ–î–ê–Ø –∑–∞–º–µ—Ç–∫–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞ H1 (#).
–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º!

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê:
1. **–ó–ê–ì–û–õ–û–í–û–ö H1 (#)**: –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –í–°–ï–ì–î–ê –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –∫—Ä–∞—Ç–∫–æ –æ—Ç—Ä–∞–∂–∞—é—â–∏–º —Å—É—Ç—å.
   - –î–ª—è –∑–∞–¥–∞—á–∏: "# –ó–∞–¥–∞—á–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é"
   - –î–ª—è –∏–¥–µ–∏: "# –ò–¥–µ—è –ø—Ä–æ–µ–∫—Ç–∞"
   - –î–ª—è –≤—Å—Ç—Ä–µ—á–∏: "# –í—Å—Ç—Ä–µ—á–∞ —Å –∫–æ–º–∞–Ω–¥–æ–π"
   - –î–ª—è –∑–∞–º–µ—Ç–∫–∏: "# –ó–∞–º–µ—Ç–∫–∞ –æ..."

2. **–ü–û–î–ó–ê–ì–û–õ–û–í–ö–ò H2 (##)**: –†–∞–∑–±–∏–≤–∞–π —Ç–µ–∫—Å—Ç –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏.
   –ü—Ä–∏–º–µ—Ä—ã: ## –¶–µ–ª–∏, ## –ö–æ–Ω—Ç–∞–∫—Ç—ã, ## –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π, ## –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏

3. **–°–ü–ò–°–ö–ò**: –í—Å–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –æ—Ñ–æ—Ä–º–ª—è–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
   - –ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ (-) –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
   - –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ (1., 2.) –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤
   - –ß–µ–∫–±–æ–∫—Å—ã ([ ]) –¥–ª—è –∑–∞–¥–∞—á –∏ –¥–µ–ª

4. **–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï**:
   - **–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤, –¥–∞—Ç, –∏–º–µ–Ω, –≤–∞–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
   - –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å

5. **–ß–ò–°–¢–û–¢–ê –¢–ï–ö–°–¢–ê**:
   - –£–±–∏—Ä–∞–π —Å–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã –∏ –≤–æ–¥—É
   - –ò—Å–ø—Ä–∞–≤–ª—è–π –≥—Ä–∞–º–º–∞—Ç–∏–∫—É
   - –°–æ—Ö—Ä–∞–Ω—è–π —Å–º—ã—Å–ª –∏ –∞–≤—Ç–æ—Ä—Å–∫–∏–π —Å—Ç–∏–ª—å

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ô –°–¢–†–£–ö–¢–£–†–´:

–í—Ö–æ–¥: "–∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ —Ö–ª–µ–± —è–π—Ü–∞"
–í—ã—Ö–æ–¥:
# –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫

- –ú–æ–ª–æ–∫–æ
- –•–ª–µ–±
- –Ø–π—Ü–∞

---

–í—Ö–æ–¥: "–ø–æ–∑–≤–æ–Ω–∏—Ç—å –ò–≤–∞–Ω—É –æ–±—Å—É–¥–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –≤—Å—Ç—Ä–µ—á–∞ –≤ 15:00"
–í—ã—Ö–æ–¥:
# –í—Å—Ç—Ä–µ—á–∞ —Å –ò–≤–∞–Ω–æ–º

## –î–µ—Ç–∞–ª–∏
- **–í—Ä–µ–º—è**: 15:00
- **–¢–µ–º–∞**: –û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

## –ó–∞–¥–∞—á–∏
- [ ] –ü–æ–∑–≤–æ–Ω–∏—Ç—å –ò–≤–∞–Ω—É
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é

–ê–ë–°–û–õ–Æ–¢–ù–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û Markdown —Ç–µ–∫—Å—Ç, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å # (–∑–∞–≥–æ–ª–æ–≤–∫–∞ H1).
–ü–∏—à–∏ –Ω–∞ —è–∑—ã–∫–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.`;

const POLISH_INSTRUCTION = `–¢—ã ‚Äî —ç–ª–∏—Ç–Ω—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–Ω–µ—Å –ø—Ä–∞–≤–∫–∏ –≤ –∑–∞–º–µ—Ç–∫—É.
–¢–≤–æ—è —Ü–µ–ª—å: –î–æ–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –¥–æ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–∞, —Å–æ—Ö—Ä–∞–Ω—è—è –∂–µ—Å—Ç–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É Markdown.

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ó–∞–º–µ—Ç–∫–∞ –û–ë–Ø–ó–ê–ù–ê –∏–º–µ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ H1 (#) –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ!

–ß–¢–û –î–ï–õ–ê–¢–¨:

1. **–ü–†–û–í–ï–†–ö–ê –°–¢–†–£–ö–¢–£–†–´**:
   - –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ H1 (#)
   - –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ —Å–º—ã—Å–ª—É
   - –ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ H2 (##) –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤

2. **–£–õ–£–ß–®–ï–ù–ò–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø**:
   - –î–æ–±–∞–≤—å **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤, –¥–∞—Ç, –∏–º–µ–Ω
   - –ü—Ä–µ–æ–±—Ä–∞–∑—É–π –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–∏ (-, 1., [ ])
   - –í—ã—Ä–æ–≤–Ω—è–π –æ—Ç—Å—Ç—É–ø—ã –∏ —Å–ø–∏—Å–∫–∏

3. **–ì–†–ê–ú–ú–ê–¢–ò–ö–ê –ò –°–¢–ò–õ–¨**:
   - –ò—Å–ø—Ä–∞–≤—å –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
   - –£–±–µ—Ä–∏ –≤–æ–¥—É –∏ —Å–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã
   - –°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–º, –Ω–æ –Ω–µ –º–µ–Ω—è–π —Å–º—ã—Å–ª

4. **–í–ò–ó–£–ê–õ–¨–ù–ê–Ø –ü–†–ò–í–õ–ï–ö–ê–¢–ï–õ–¨–ù–û–°–¢–¨**:
   - –î–æ–±–∞–≤—å –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
   - –ò—Å–ø–æ–ª—å–∑—É–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ (---) –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
- –ù–ï –º–µ–Ω—è–π —Å–º—ã—Å–ª, –∫–æ—Ç–æ—Ä—ã–π –≤–ª–æ–∂–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç —Å–µ–±—è
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≥–æ—Ç–æ–≤—ã–π Markdown —Ç–µ–∫—Å—Ç –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π

–†–ï–ó–£–õ–¨–¢–ê–¢: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≥–æ—Ç–æ–≤—ã–π Markdown —Ç–µ–∫—Å—Ç, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å # (–∑–∞–≥–æ–ª–æ–≤–æ–∫ H1).`;

const VOICE_CLEANUP_INSTRUCTION = `–¢—ã ‚Äî –º–æ–¥—É–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ (STT) –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.

‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –í–°–ï–ì–î–ê –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º H1 (#)!

–≠–¢–ê–ü–´ –û–ë–†–ê–ë–û–¢–ö–ò:

1. **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–û–ö STT**:
   - –ò—Å–ø—Ä–∞–≤—å –æ–∫–æ–Ω—á–∞–Ω–∏—è, –ø–∞–¥–µ–∂–∏ –∏ –æ–ø–µ—á–∞—Ç–∫–∏
   - –†–∞—Å—Å—Ç–∞–≤—å –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –ø–æ —Å–º—ã—Å–ª—É
   - –£–±–µ—Ä–∏ –ø–æ–≤—Ç–æ—Ä—ã –∏ –º—É—Å–æ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞

2. **–ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø –ì–û–õ–û–°–û–í–´–• –ö–û–ú–ê–ù–î** (–ù–ï –ø–∏—à–∏ –∏—Ö —Ç–µ–∫—Å—Ç–æ–º):
   - "–ó–∞–≥–æ–ª–æ–≤–æ–∫..." ‚Üí # –ó–∞–≥–æ–ª–æ–≤–æ–∫
   - "–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫..." ‚Üí ## –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫  
   - "–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞" / "–ê–±–∑–∞—Ü" ‚Üí –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
   - "–ü—É–Ω–∫—Ç..." / "–¢–∏—Ä–µ..." ‚Üí - ...
   - "–ß–µ–∫–±–æ–∫—Å..." / "–ó–∞–¥–∞—á–∞..." ‚Üí [ ] ...

3. **–î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ì–û–õ–û–í–ö–ê** (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–æ–∏–∑–Ω–µ—Å):
   - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
   - –ü—Ä–∏–¥—É–º–∞–π –∫—Ä–∞—Ç–∫–∏–π –∏ —Ç–æ—á–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ H1
   - –ü–æ—Å—Ç–∞–≤—å –µ–≥–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–æ–π

–ü–†–ò–ú–ï–†–´:

–í—Ö–æ–¥: "–∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ —è–π—Ü–∞ —Ö–ª–µ–±"
–í—ã—Ö–æ–¥:
# –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫

- –ú–æ–ª–æ–∫–æ
- –Ø–π—Ü–∞
- –•–ª–µ–±

---

–í—Ö–æ–¥: "–∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–¥–µ–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ –¥–æ–±–∞–≤–∏—Ç—å –∏–∏"
–í—ã—Ö–æ–¥:
# –ò–¥–µ–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞

- –°–¥–µ–ª–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞–º–µ—Ç–æ–∫
- –î–æ–±–∞–≤–∏—Ç—å –ò–ò

---

–í—Ö–æ–¥: "–≤—Å—Ç—Ä–µ—á–∞ —Å –°–∞—à–µ–π –∑–∞–≤—Ç—Ä–∞ –≤ —Ç—Ä–∏ —á–∞—Å–∞ –æ–±—Å—É–¥–∏—Ç—å –º–∞—Ä–∫–µ—Ç–∏–Ω–≥"
–í—ã—Ö–æ–¥:
# –í—Å—Ç—Ä–µ—á–∞ —Å –°–∞—à–µ–π

- **–í—Ä–µ–º—è**: –ó–∞–≤—Ç—Ä–∞ –≤ 3 —á–∞—Å–∞
- **–¢–µ–º–∞**: –û–±—Å—É–¥–∏—Ç—å –º–∞—Ä–∫–µ—Ç–∏–Ω–≥

–†–ï–ó–£–õ–¨–¢–ê–¢: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≥–æ—Ç–æ–≤—ã–π Markdown —Ç–µ–∫—Å—Ç, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å # (–∑–∞–≥–æ–ª–æ–≤–æ–∫ H1).
–ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π —Ç–∏–ø–∞ "–í–æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç". –¢–æ–ª—å–∫–æ —Å–∞–º —Ç–µ–∫—Å—Ç!`;

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ OpenRouter —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π fetch.
 * –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —Ç–∞–∫ –∫–∞–∫ –∫–ª—é—á–∏ OpenRouter –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å Google GenAI SDK.
 */
/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –Ω–∞—à–µ–º—É API (Serverless Function).
 * –≠—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç –∫–ª—é—á–∏ API –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å CORS.
 */
async function callBackendAPI(prompt: string, instruction: string, model: string): Promise<string | null> {
  try {
    console.log("üîÑ SnapNote: Trying Backend API...");
    const response = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, instruction, model })
    });

    // If we get an HTML response (likely Vite serving index.html for unknown route), throw to trigger fallback
    const contentType = response.headers.get("content-type");
    if (contentType && contentType.includes("text/html")) {
      throw new Error("Local environment detected (HTML response from API)");
    }

    if (!response.ok) {
      // If it's a 404, it might be local dev without API support -> fallback
      if (response.status === 404) throw new Error("API not found (404)");
      const error = await response.text();
      console.error(`SnapNote: Backend Error (${response.status}):`, error);
      return null;
    }

    const data = await response.json();
    const result = data.choices?.[0]?.message?.content || null;
    console.log("‚úÖ SnapNote: Backend AI Success", result ? `(${result.length} chars)` : "(null)");
    return result;
  } catch (error) {
    console.warn("‚ö†Ô∏è SnapNote: Backend unreachable, trying client-side fallback...", error);
    throw error; // Rethrow to trigger fallback
  }
}

async function callOpenRouter(prompt: string, instruction: string, model: string, apiKey: string): Promise<string | null> {
  try {
    console.log("üîÑ SnapNote: Using Client-side OpenRouter...");
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`,
        "HTTP-Referer": "https://snapnote.tma",
        "X-Title": "SnapNote TMA"
      },
      body: JSON.stringify({
        model,
        messages: [
          { role: "system", content: instruction },
          { role: "user", content: `IMPORTANT INSTRUCTION:\n${instruction}\n\nUSER CONTENT:\n${prompt}` }
        ],
        temperature: 0.3,
        max_tokens: 1000
      })
    });

    if (!response.ok) {
      console.error("‚ùå SnapNote: OpenRouter Error", response.status);
      return null;
    }
    const data = await response.json();
    const result = data.choices?.[0]?.message?.content || null;
    console.log("‚úÖ SnapNote: Client-side AI Success", result ? `(${result.length} chars)` : "(null)");
    return result;
  } catch (e) {
    console.error("‚ùå SnapNote: Client-side API error", e);
    return null;
  }
}

async function callAI(prompt: string, instruction: string, model: string, clientKey?: string): Promise<string | null> {
  console.log(`ü§ñ SnapNote: Processing with AI (${model})...`);
  try {
    return await callBackendAPI(prompt, instruction, model);
  } catch (e) {
    if (clientKey) {
      console.log("SnapNote: Falling back to Client-side API call");
      return callOpenRouter(prompt, instruction, model, clientKey);
    }
    console.error("SnapNote: API Failed and no client key provided for fallback.");
    return null;
  }
}

export async function processNoteWithAI(text: string): Promise<string | null> {
  // Use VITE_API_KEY as fallback
  return callAI(text, SYSTEM_INSTRUCTION, MODEL_GEMMA, import.meta.env.VITE_API_KEY);
}

export async function improveEditedNote(text: string): Promise<string | null> {
  return callAI(text, POLISH_INSTRUCTION, MODEL_GEMMA, import.meta.env.VITE_API_KEY);
}

export async function processVoiceTranscript(text: string): Promise<string | null> {
  const key = import.meta.env.VITE_VOICE_AI_KEY || import.meta.env.VITE_API_KEY;
  return callAI(text, VOICE_CLEANUP_INSTRUCTION, MODEL_GEMINI_FLASH_LITE, key);
}
